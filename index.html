<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HariPrabodham Aatmiya Anand</title>
  <link rel="stylesheet" href="./index.css">
</head>
<body>

<header>
  <h1>HariPrabodham Aatmiya Anand</h1>
  <p>Games â€¢ Learning â€¢ Joy</p>
</header>

<!-- HOME PAGE -->
<div id="home" class="container">
  <div class="game-box" onclick="openBingo()">
    <h2>ðŸŽ¯ Bingo</h2>
    <p>Play together and enjoy</p>
  </div>

  <div class="game-box">
    <h2>ðŸ§© Coming Soon</h2>
    <p>More games will be added</p>
  </div>
</div>

<!-- BINGO PAGE -->
<div id="bingo" class="container hidden">
  <div style="grid-column: 1 / -1; text-align:center;">
    <h2>Bingo Game</h2>
    <label>Number of Participants: </label>
    <input type="number" id="participants" min="1" max="50" value="5" />
    <br/><br/>
    <button onclick="generateBingo()">Generate Bingo Sheets</button>
    <button onclick="drawNumber()">Draw Number</button>
    <button onclick="goHome()">Back to Home</button>

    <div class="number-display" id="currentNumber">â€“</div>
  </div>

  <div id="boards"></div>
</div>

<script>
  let drawnNumbers = [];
  let allNumbers = Array.from({ length: 75 }, (_, i) => i + 1);

  function openBingo() {
    document.getElementById('home').classList.add('hidden');
    document.getElementById('bingo').classList.remove('hidden');
  }

  function goHome() {
    document.getElementById('bingo').classList.add('hidden');
    document.getElementById('home').classList.remove('hidden');
    document.getElementById('boards').innerHTML = '';
    drawnNumbers = [];
    document.getElementById('currentNumber').innerText = 'â€“';
  }

  function generateBingo() {
    const count = document.getElementById('participants').value;
    const boardsDiv = document.getElementById('boards');
    boardsDiv.innerHTML = '';

    for (let i = 1; i <= count; i++) {
      const board = document.createElement('div');
      board.style.margin = '20px';
      board.innerHTML = `<h4>Player ${i}</h4>`;

      const grid = document.createElement('div');
      grid.className = 'bingo-board';

      const numbers = shuffle(allNumbers).slice(0, 25);
      numbers.forEach(num => {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.innerText = num;
        grid.appendChild(cell);
      });

      // HOST VIEW: show ONLY QR code, NOT the bingo grid
      const link = generatePlayerLink(numbers);
      const qr = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(link)}`;

      const qrBox = document.createElement('div');
      qrBox.style.textAlign = 'center';
      qrBox.innerHTML = `
        <p style="font-size:14px;">Player ${i}</p>
        <img src="${qr}" alt="QR Code" />
        <p style="font-size:11px; word-break:break-all;">Scan to get your Bingo Sheet</p>
      `;

      board.appendChild(qrBox);
      boardsDiv.appendChild(board);
    }
  }

  function drawNumber() {
    const remaining = allNumbers.filter(n => !drawnNumbers.includes(n));
    if (remaining.length === 0) return alert('All numbers drawn');

    const num = remaining[Math.floor(Math.random() * remaining.length)];
    drawnNumbers.push(num);
    document.getElementById('currentNumber').innerText = num;
  }

  function shuffle(arr) {
    return [...arr].sort(() => Math.random() - 0.5);
  }
  
  /* =====================
     QR / UNIQUE LINK BINGO LOGIC (FIXED)
     ===================== */

  /*
    IMPORTANT FIX:
    Player opens the link on THEIR device, so they do NOT share memory
    with the host browser. Therefore we ENCODE the bingo board in the URL.
    This makes QR codes work perfectly without any backend.
  */

  function generatePlayerLink(boardNumbers) {
    const encodedBoard = btoa(JSON.stringify(boardNumbers));
    const url = `${window.location.origin}${window.location.pathname}?playerBoard=${encodedBoard}`;
    return url;
  }

  function generateBingo() {
    const count = document.getElementById('participants').value;
    const boardsDiv = document.getElementById('boards');
    boardsDiv.innerHTML = '';

    for (let i = 1; i <= count; i++) {
      const board = document.createElement('div');
      board.style.margin = '20px';
      board.innerHTML = `<h4>Player ${i}</h4>`;

      const grid = document.createElement('div');
      grid.className = 'bingo-board';

      const numbers = shuffle(allNumbers).slice(0, 25);
      numbers.forEach(num => {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.innerText = num;
        grid.appendChild(cell);
      });

      const link = generatePlayerLink(numbers);
      const qr = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(link)}`;

      const linkBox = document.createElement('div');
      linkBox.innerHTML = `
        <p style="font-size:12px; word-break:break-all;">${link}</p>
        <img src="${qr}" alt="QR Code" />
      `;

      board.appendChild(grid);
      board.appendChild(linkBox);
      boardsDiv.appendChild(board);
    }
  }

  function loadPlayerBoard() {
    const params = new URLSearchParams(window.location.search);
    const encoded = params.get('playerBoard');
    if (!encoded) return;

    const numbers = JSON.parse(atob(encoded));

    document.body.innerHTML = `
      <h2 style="text-align:center">Your Bingo Board</h2>
      <p style="text-align:center; font-size:14px;">Scan-and-play mode</p>
    `;

    const grid = document.createElement('div');
    grid.className = 'bingo-board';
    grid.style.margin = '20px auto';

    numbers.forEach(num => {
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.innerText = num;
      grid.appendChild(cell);
    });

    document.body.appendChild(grid);
  }

  window.onload = loadPlayerBoard;

</script>

</body>
</html>
